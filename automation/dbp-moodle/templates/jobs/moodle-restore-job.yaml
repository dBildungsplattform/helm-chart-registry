{{- if .Values.dbpMoodle.restore.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ .Release.Name }}-restore-job"
  namespace: {{ .Release.Namespace }}
spec:
  backoffLimit: {{ .Values.dbpMoodle.restore.backoffLimit | default "4" }}
  template:
    spec:
      volumes:
      - name: moodle-data
        persistentVolumeClaim:
          claimName: {{ include "dbpMoodle.moodlePvc.name" . }}
      - name: moodle-restore-script
        configMap:
          name: moodle-restore-script
          defaultMode: 0711
      - name: duply
        projected:
          sources:
            - configMap:
                name: moodle-duply
                items:
                  - key: conf
                    path: conf
                  - key: exclude
                    path: exclude
            - secret:
                name: {{ .Values.dbpMoodle.restore.existingSecretGPG }}
          defaultMode: 0644
      serviceAccountName: moodle-restore-job
      serviceAccount: moodle-restore-job
      containers:
      - name:  moodle-restore-job
        image: "{{ .Values.dbpMoodle.restore.image_repository }}/infra-tools:{{ .Values.dbpMoodle.restore.image_tag }}"
        command:
          - /bin/sh
          - -c
        args:
          - /scripts/restore-script
        resources:
          limits:
            cpu: 2000m
            memory: 16Gi
          requests:
            cpu: 1000m
            memory: 8Gi
        volumeMounts:
        - name: moodle-data
          mountPath: /bitnami/moodle
          subPath: moodle
        - name: moodle-data
          mountPath: /bitnami/moodledata
          subPath: moodledata
        - name: moodle-restore-script
          mountPath: /scripts/
        - name: duply
          mountPath: /etc/duply/default/
        env:
        - name: DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.dbpMoodle.restore.existingSecretDatabase }}
              key: {{ .Values.dbpMoodle.restore.existingSecretKeyDatabase }}
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: {{ .Values.dbpMoodle.restore.existingSecretS3 }}
              key: {{ .Values.dbpMoodle.restore.existingSecretKeyS3Access }}
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: {{ .Values.dbpMoodle.restore.existingSecretS3 }}
              key: {{ .Values.dbpMoodle.restore.existingSecretKeyS3Secret }}
      affinity: {{ .Values.dbpMoodle.moodleRestoreJob.affinity | toYaml }}
      tolerations: {{ .Values.dbpMoodle.moodleRestoreJob.tolerations | toYaml }}
      restartPolicy: Never
{{- end }}
